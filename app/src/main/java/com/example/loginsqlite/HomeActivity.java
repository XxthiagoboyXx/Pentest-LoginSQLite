package com.example.loginsqlite;

import androidx.appcompat.app.AppCompatActivity;

import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.content.SharedPreferences;
import android.net.wifi.WifiManager;
import android.os.Bundle;
import android.util.Log;
import android.view.View;
import android.widget.Button;
import android.widget.CheckBox;
import android.widget.ImageButton;
import android.widget.TextView;
import android.widget.Toast;

import com.google.android.material.floatingactionbutton.FloatingActionButton;

import java.util.concurrent.ExecutionException;

public class HomeActivity extends AppCompatActivity {

    TextView textPhrase;
    Button newPhrase;
    CheckBox isSavePhrase;
    FloatingActionButton searchMorePhrases;
    ImageButton sharePhrase;

    //Para o BroadcastReceiver
    private ShareReceiver receiver =  new ShareReceiver();

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_home);

        textPhrase = (TextView) findViewById(R.id.text_homepage);
        newPhrase = (Button) findViewById(R.id.btnnewphrase_homepage);
        isSavePhrase = (CheckBox) findViewById(R.id.checkBox_homepage);
        searchMorePhrases = (FloatingActionButton) findViewById(R.id.fab_homepage);
        sharePhrase = (ImageButton) findViewById(R.id.sharebtn_homepage);

        SharedPreferences prefs = getSharedPreferences("preferences", Context.MODE_PRIVATE);
        String prefPhrase = prefs.getString("phrase","");

        if(prefPhrase.equals("") || prefPhrase.equals(null)) { //recuperar a frase em preferences
            setNewPhrase();
        }
        else{
            textPhrase.setText(prefs.getString("phrase",""));
            isSavePhrase.setChecked(true);
        }
        isSavePhrase.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                SharedPreferences.Editor ed = prefs.edit();
                if(isSavePhrase.isChecked()){
                    ed.putString("phrase", textPhrase.getText().toString());
                    ed.apply();
                    Log.d("responseAPI", "AAAAAAA");
                }
                else{ //apaga o que est√° salvo no preferences
                    ed.putString("phrase","");
                    ed.apply();
                }
            }
        });

        newPhrase.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                if(!isSavePhrase.isChecked()) {
                    setNewPhrase();
                }
                else{
                    Toast.makeText(HomeActivity.this, "Please, disable \"Save Phrase\"!", Toast.LENGTH_LONG).show();
                }
            }
        });

        //Abrindo WebViewPage
        searchMorePhrases.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                Intent intent = new Intent(getApplicationContext(), WebViewActivity.class);
                startActivity(intent);
            }
        });
        //-----------------------

        //Implementando o AIRPLANE com BroadcastReceiver
        IntentFilter intentFilter = new IntentFilter();
        //intentFilter.addAction(Intent.ACTION_MEDIA_SHARED);
        intentFilter.addAction(Intent.ACTION_AIRPLANE_MODE_CHANGED);

        registerReceiver(receiver, intentFilter); //registra o receiver criado ao filtro de intents


        //Implementando o Share com BroadcastReceiver
        sharePhrase.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                Intent sendIntent = new Intent();
                sendIntent.setAction(Intent.ACTION_SEND);
                sendIntent.putExtra(Intent.EXTRA_TEXT, textPhrase.getText().toString()); //pegando a frase atual para compartilhar
                sendIntent.setType("text/plain");

                Intent shareIntent = Intent.createChooser(sendIntent, null);
                startActivity(shareIntent);
            }
        });
        //-----------------------


    }

    private void setNewPhrase(){
        String responseAPI = null;
        BackgroundTask backgroundTask = new BackgroundTask();
        try {
            responseAPI = backgroundTask.execute().get();
        } catch (ExecutionException e) {
            e.printStackTrace();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        textPhrase.setText(responseAPI);
    }

    //Fechando o Receiver ao fechar o app
    @Override
    protected void onDestroy() {
        super.onDestroy();
        unregisterReceiver(receiver);
    }
}